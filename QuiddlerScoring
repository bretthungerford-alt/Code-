<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiddler Scorekeeper</title>
  <style>
    :root { --pad: 12px; --border: #ddd; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 14px var(--pad); border-bottom: 1px solid var(--border); position: sticky; top: 0; background: #fff; }
    main { padding: var(--pad); max-width: 1100px; margin: 0 auto; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button, input, select { font: inherit; }
    button { padding: 10px 12px; border: 1px solid var(--border); background: #fff; border-radius: 10px; cursor: pointer; }
    button.primary { border-color: #000; }
    button.danger { border-color: #c33; color: #c33; }
    input[type="text"], input[type="number"] {
      padding: 10px; border: 1px solid var(--border); border-radius: 10px;
    }
    input[type="number"] { width: 92px; }
    .card { border: 1px solid var(--border); border-radius: 14px; padding: var(--pad); }
    .muted { color: #666; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-align: left; position: sticky; top: 62px; background: #fff; z-index: 1; }
    td small { color: #666; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; margin-left: 6px; }
    .nowrap { white-space: nowrap; }
    .grid2 { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 900px) { .grid2 { grid-template-columns: 1fr 1fr; } }
    .right { text-align: right; }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between;">
    <div>
      <div style="font-weight:700;">Quiddler Scorekeeper</div>
      <div class="muted" style="font-size:13px;">8 rounds (3→10 cards). Bonuses split on ties. Autosaves on this device.</div>
    </div>
    <div class="row">
      <button id="exportBtn">Export CSV</button>
      <button id="resetBtn" class="danger">Reset</button>
    </div>
  </div>
</header>

<main class="grid2">
  <section class="card">
    <div style="font-weight:700;margin-bottom:10px;">Players</div>
    <div class="row">
      <input id="playerName" type="text" placeholder="Add player name" style="flex:1;min-width:190px;">
      <button id="addPlayerBtn" class="primary">Add</button>
    </div>
    <div id="playerList" style="margin-top:10px;"></div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;" />

    <div style="font-weight:700;margin-bottom:6px;">Round</div>
    <div class="row">
      <select id="roundSel" style="padding:10px;border:1px solid var(--border);border-radius:10px;">
        <option value="1">Round 1 (3 cards)</option>
        <option value="2">Round 2 (4 cards)</option>
        <option value="3">Round 3 (5 cards)</option>
        <option value="4">Round 4 (6 cards)</option>
        <option value="5">Round 5 (7 cards)</option>
        <option value="6">Round 6 (8 cards)</option>
        <option value="7">Round 7 (9 cards)</option>
        <option value="8">Round 8 (10 cards)</option>
      </select>
      <span class="muted">Bonuses: +10 split among checked winners.</span>
    </div>

    <div style="margin-top:12px;" class="muted">
      Scoring per player, per round:
      <span class="pill nowrap">max(0, WordPoints − UnusedPoints) + splitBonuses + challengeAdj</span>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:700;">Enter scores for selected round</div>
      <div class="muted" id="roundHelp"></div>
    </div>

    <div id="entryArea" style="margin-top:10px;"></div>

    <div class="row" style="justify-content:flex-end;margin-top:10px;">
      <button id="applyBtn" class="primary">Save Round Scores</button>
    </div>
  </section>

  <section class="card" style="grid-column:1 / -1;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:700;">Leaderboard</div>
      <div class="muted" id="lastSaved"></div>
    </div>
    <div style="overflow:auto;margin-top:10px;">
      <table id="scoreTable"></table>
    </div>
  </section>
</main>

<script>
(() => {
  const STORAGE_KEY = "quiddler_scorekeeper_v2_split_bonus";

  const state = load() ?? {
    players: [], // {id, name}
    // rounds[r][playerId] = {word, unused, longWin(bool), mostWin(bool), chall, bonusLong, bonusMost, total}
    rounds: Array.from({length: 8}, () => ({})),
    updatedAt: null
  };

  const $ = (id) => document.getElementById(id);

  const roundCards = (r) => 2 + r; // r=1 -> 3 cards ... r=8 -> 10 cards
  const fmtTime = (ts) => ts ? new Date(ts).toLocaleString() : "";

  function save() {
    state.updatedAt = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    $("lastSaved").textContent = state.updatedAt ? `Saved: ${fmtTime(state.updatedAt)}` : "";
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function addPlayer(name) {
    const clean = (name ?? "").trim();
    if (!clean) return;
    state.players.push({ id: uid(), name: clean });
    save();
    renderAll();
  }

  function removePlayer(id) {
    state.players = state.players.filter(p => p.id !== id);
    for (let r = 0; r < 8; r++) delete state.rounds[r][id];
    save();
    renderAll();
  }

  function baseScore(word, unused) {
    return Math.max(0, Number(word || 0) - Number(unused || 0));
  }

  function roundTotal(entry) {
    const base = baseScore(entry.word, entry.unused);
    const bonusLong = Number(entry.bonusLong || 0);
    const bonusMost = Number(entry.bonusMost || 0);
    const chall = Number(entry.chall || 0);
    return base + bonusLong + bonusMost + chall;
  }

  function splitBonusesFromUI() {
    const rows = [...document.querySelectorAll("#entryArea tbody tr")];
    const longWinners = rows.filter(tr => tr.querySelector('[data-k="longWin"]')?.checked);
    const mostWinners = rows.filter(tr => tr.querySelector('[data-k="mostWin"]')?.checked);

    const longShare = longWinners.length ? (10 / longWinners.length) : 0;
    const mostShare = mostWinners.length ? (10 / mostWinners.length) : 0;

    // Map: playerId -> {bonusLong, bonusMost}
    const bonuses = new Map();
    for (const tr of rows) bonuses.set(tr.getAttribute("data-pid"), { bonusLong: 0, bonusMost: 0 });

    for (const tr of longWinners) bonuses.get(tr.getAttribute("data-pid")).bonusLong = longShare;
    for (const tr of mostWinners) bonuses.get(tr.getAttribute("data-pid")).bonusMost = mostShare;

    return bonuses;
  }

  function renderPlayers() {
    const wrap = $("playerList");
    if (state.players.length === 0) {
      wrap.innerHTML = `<div class="muted">Add players to start.</div>`;
      return;
    }
    wrap.innerHTML = state.players.map(p => `
      <div class="row" style="justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px;">
        <div><b>${escapeHtml(p.name)}</b></div>
        <button class="danger" data-del="${p.id}">Remove</button>
      </div>
    `).join("");

    wrap.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => removePlayer(btn.getAttribute("data-del")));
    });
  }

  function renderEntryArea() {
    const r = Number($("roundSel").value);
    $("roundHelp").textContent = `Round ${r} (${roundCards(r)} cards)`;

    const area = $("entryArea");
    if (state.players.length === 0) {
      area.innerHTML = `<div class="muted">Add at least one player.</div>`;
      return;
    }

    const roundObj = state.rounds[r-1];

    area.innerHTML = `
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Player</th>
              <th class="nowrap">Word Points<br><small>(sum of cards in valid words)</small></th>
              <th class="nowrap">Unused Points<br><small>(cards left over)</small></th>
              <th class="nowrap">Longest Winners<br><small>(splits +10)</small></th>
              <th class="nowrap">Most Words Winners<br><small>(splits +10)</small></th>
              <th class="nowrap">Challenge Adj<br><small>(optional ±)</small></th>
              <th class="right nowrap">Round Total</th>
            </tr>
          </thead>
          <tbody>
            ${state.players.map(p => {
              const e = roundObj[p.id] ?? {word:0, unused:0, longWin:false, mostWin:false, chall:0, bonusLong:0, bonusMost:0, total:0};
              return `
                <tr data-pid="${p.id}">
                  <td><b>${escapeHtml(p.name)}</b></td>
                  <td><input type="number" min="0" step="1" value="${Number(e.word||0)}" data-k="word"></td>
                  <td><input type="number" min="0" step="1" value="${Number(e.unused||0)}" data-k="unused"></td>
                  <td><input type="checkbox" ${e.longWin ? "checked":""} data-k="longWin"></td>
                  <td><input type="checkbox" ${e.mostWin ? "checked":""} data-k="mostWin"></td>
                  <td><input type="number" step="1" value="${Number(e.chall||0)}" data-k="chall"></td>
                  <td class="right"><span class="pill" data-k="total">0</span></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px;font-size:13px;">
        Tip: If there’s a tie, just check all tied players — the app splits the +10 evenly (e.g., 2-way tie = +5 each).
      </div>
    `;

    // live recalc
    area.querySelectorAll("tbody tr").forEach(tr => {
      tr.addEventListener("input", () => updateAllTotals());
      tr.addEventListener("change", () => updateAllTotals());
    });

    updateAllTotals();
  }

  function readRow(tr) {
    const get = (k) => {
      const el = tr.querySelector(`[data-k="${k}"]`);
      if (!el) return null;
      if (el.type === "checkbox") return el.checked;
      return el.value;
    };
    return {
      word: get("word"),
      unused: get("unused"),
      longWin: get("longWin"),
      mostWin: get("mostWin"),
      chall: get("chall"),
    };
  }

  function updateAllTotals() {
    const bonuses = splitBonusesFromUI();
    document.querySelectorAll("#entryArea tbody tr").forEach(tr => {
      const pid = tr.getAttribute("data-pid");
      const e = readRow(tr);
      const b = bonuses.get(pid) || {bonusLong:0, bonusMost:0};
      const total = roundTotal({ ...e, ...b });
      tr.querySelector('[data-k="total"]').textContent = pretty(total);
    });
  }

  function applyRound() {
    const r = Number($("roundSel").value);
    const roundObj = state.rounds[r-1];

    const bonuses = splitBonusesFromUI();

    document.querySelectorAll("#entryArea tbody tr").forEach(tr => {
      const pid = tr.getAttribute("data-pid");
      const e = readRow(tr);
      const b = bonuses.get(pid) || {bonusLong:0, bonusMost:0};
      const total = roundTotal({ ...e, ...b });

      roundObj[pid] = {
        ...e,
        bonusLong: b.bonusLong,
        bonusMost: b.bonusMost,
        total: total
      };
    });

    save();
    renderScores();
    updateAllTotals();
  }

  function totalsByPlayer() {
    const totals = new Map();
    for (const p of state.players) totals.set(p.id, 0);
    for (let r = 0; r < 8; r++) {
      const ro = state.rounds[r];
      for (const p of state.players) {
        totals.set(p.id, (totals.get(p.id) || 0) + Number((ro[p.id]?.total) || 0));
      }
    }
    return totals;
  }

  function renderScores() {
    const table = $("scoreTable");
    if (state.players.length === 0) {
      table.innerHTML = `<tr><td class="muted">No players yet.</td></tr>`;
      return;
    }

    const totals = totalsByPlayer();
    const sorted = [...state.players].sort((a,b) => (totals.get(b.id) - totals.get(a.id)) || a.name.localeCompare(b.name));

    const head = `
      <thead>
        <tr>
          <th>Player</th>
          ${Array.from({length:8}, (_,i)=>`<th class="right nowrap">R${i+1}</th>`).join("")}
          <th class="right nowrap">Total</th>
        </tr>
      </thead>
    `;

    const body = `
      <tbody>
        ${sorted.map(p => {
          const perRound = state.rounds.map(ro => Number(ro[p.id]?.total || 0));
          return `
            <tr>
              <td><b>${escapeHtml(p.name)}</b></td>
              ${perRound.map(v => `<td class="right">${pretty(v)}</td>`).join("")}
              <td class="right"><b>${pretty(totals.get(p.id))}</b></td>
            </tr>
          `;
        }).join("")}
      </tbody>
    `;

    table.innerHTML = head + body;
    $("lastSaved").textContent = state.updatedAt ? `Saved: ${fmtTime(state.updatedAt)}` : "";
  }

  function exportCSV() {
    const totals = totalsByPlayer();
    const header = ["Player","R1","R2","R3","R4","R5","R6","R7","R8","Total"];
    const rows = state.players.map(p => {
      const perRound = state.rounds.map(ro => Number(ro[p.id]?.total || 0));
      return [p.name, ...perRound.map(pretty), pretty(totals.get(p.id) || 0)];
    });
    const csv = [header, ...rows]
      .map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(","))
      .join("\n");

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "quiddler-scores.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll() {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function pretty(n) {
    const x = Number(n || 0);
    // show up to 2 decimals only when needed
    return (Math.abs(x - Math.round(x)) < 1e-9) ? String(Math.round(x)) : x.toFixed(2);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderAll() {
    renderPlayers();
    renderEntryArea();
    renderScores();
  }

  // events
  $("addPlayerBtn").addEventListener("click", () => {
    addPlayer($("playerName").value);
    $("playerName").value = "";
    $("playerName").focus();
  });
  $("playerName").addEventListener("keydown", (e) => {
    if (e.key === "Enter") $("addPlayerBtn").click();
  });

  $("roundSel").addEventListener("change", renderEntryArea);
  $("applyBtn").addEventListener("click", applyRound);
  $("exportBtn").addEventListener("click", exportCSV);
  $("resetBtn").addEventListener("click", resetAll);

  // initial
  renderAll();
  $("lastSaved").textContent = state.updatedAt ? `Saved: ${fmtTime(state.updatedAt)}` : "";
})();
</script>
</body>
</html>
